# Настройка Webhook для получения уведомлений от Robokassa

## Проблема: статус платежа не обновляется

Если статус платежа остается "pending" и не обновляется на "success", это означает, что webhook от Robokassa не доходит до вашего сервера или не обрабатывается правильно.

## Основные причины:

1. **Сервер недоступен из интернета** - самая частая причина
2. **Неправильно настроены URL в личном кабинете Robokassa**
3. **Неправильные пароли (тестовые/рабочие)**
4. **Проблемы с проверкой подписи**

## Решение:

### 1. Настройка публичного доступа к серверу

Ваш бот работает локально на порту 8080, но Robokassa должен иметь возможность отправить POST запрос на ваш сервер. Есть несколько вариантов:

#### Вариант A: Использование ngrok (для тестирования)

1. Установите ngrok: https://ngrok.com/download

2. Запустите ngrok в отдельном терминале:
   ```bash
   ngrok http 8080
   ```

3. Скопируйте полученный HTTPS URL (например: `https://abc123.ngrok.io`)

4. В личном кабинете Robokassa укажите:
   - **Result URL**: `https://abc123.ngrok.io/robokassa/result`
   - **Success URL**: `https://abc123.ngrok.io/robokassa/success`
   - **Fail URL**: `https://abc123.ngrok.io/robokassa/fail`

⚠️ **Важно**: URL от ngrok меняется при каждом запуске (если нет платного аккаунта). Для постоянного решения используйте вариант B.

#### Вариант B: Развертывание на VPS сервере

1. Разверните бота на VPS сервере с публичным IP
2. Настройте домен и SSL сертификат (Let's Encrypt)
3. Укажите постоянные URL в настройках Robokassa:
   - **Result URL**: `https://ваш-домен.com/robokassa/result`
   - **Success URL**: `https://ваш-домен.com/robokassa/success`
   - **Fail URL**: `https://ваш-домен.com/robokassa/fail`

### 2. Настройка URL в личном кабинете Robokassa

1. Зайдите в личный кабинет: https://auth.robokassa.ru/
2. Перейдите в раздел "Настройки магазина" → "Технические настройки"
3. Найдите раздел "URL для уведомлений"

4. Заполните следующие поля:

   **Result URL** (обязательно):
   ```
   https://ваш-домен.com/robokassa/result
   ```
   - Это URL, куда Robokassa отправляет POST запрос с результатом оплаты
   - Используется для автоматического обновления статуса платежа
   - **Тип запроса**: POST
   - **Формат ответа**: `OK{InvId}` - обязательно!

   **Success URL**:
   ```
   https://ваш-домен.com/robokassa/success
   ```
   - URL, куда перенаправляется пользователь после успешной оплаты
   - Используется только для редиректа, обработка платежа идет через Result URL

   **Fail URL**:
   ```
   https://ваш-домен.com/robokassa/fail
   ```
   - URL, куда перенаправляется пользователь при ошибке оплаты

5. **Важно**: Если у вас два магазина (для разных каналов), настройте URL для каждого магазина отдельно!

### 3. Проверка режима тестирования

⚠️ **КРИТИЧЕСКИ ВАЖНО**: В тестовом режиме (`ROBOKASSA_TEST_MODE=True`) используйте **ТЕСТОВЫЕ** пароли!

1. В личном кабинете Robokassa перейдите в "Технические настройки"
2. Найдите раздел "Тестовые пароли" (или "Test Passwords")
3. Скопируйте тестовые пароли:
   - **Тестовый Пароль #1** → `ROBOKASSA_CHANNEL_1_PASSWORD_1` в `.env`
   - **Тестовый Пароль #2** → `ROBOKASSA_CHANNEL_1_PASSWORD_2` в `.env`
   - (то же для channel_2, если используется)

4. Убедитесь, что в `.env` указано:
   ```env
   ROBOKASSA_TEST_MODE=True
   ```

### 4. Проверка работы webhook

После настройки проверьте логи бота при попытке оплаты:

```
[Robokassa] Received payment notification: {...}
[Robokassa] OutSum=1990.00, InvId=1234567890, SignatureValue=...
[Robokassa] Payment found: {...}
[Robokassa] Signature verified successfully for InvId=1234567890
[Robokassa] Payment status updated to 'success' for InvId=1234567890
```

Если видите ошибки:
- `ERROR: Missing parameters` - проверьте, что Result URL правильный
- `ERROR: Payment not found` - проверьте, что InvId соответствует ID в базе
- `ERROR: Invalid signature` - проверьте пароли (тестовые/рабочие)

### 5. Ручное обновление статуса (для тестирования)

Если webhook не работает, можно временно обновить статус вручную:

```sql
UPDATE payments SET status = 'success' WHERE payment_id = '1764952170285320';
```

Но это только для тестирования! В продакшене все должно работать автоматически через webhook.

## Типичные ошибки:

### Ошибка: "Payment not found"
- Проверьте, что `InvId` в уведомлении от Robokassa совпадает с `payment_id` в базе данных
- Убедитесь, что платеж был создан перед попыткой оплаты

### Ошибка: "Invalid signature"
- Проверьте, что используете правильные пароли (тестовые в тестовом режиме)
- Убедитесь, что пароли скопированы полностью, без лишних пробелов
- Проверьте, что в `.env` файле нет кавычек вокруг значений

### Webhook не приходит
- Убедитесь, что сервер доступен из интернета (проверьте через браузер или curl)
- Проверьте, что URL в настройках Robokassa правильные (HTTPS обязателен)
- Проверьте логи сервера на наличие входящих запросов
- Убедитесь, что порт 8080 открыт в firewall

## Проверка доступности webhook:

Протестируйте, что ваш webhook доступен:

```bash
# Замените на ваш URL
curl -X POST https://ваш-домен.com/robokassa/result \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "OutSum=1990.00&InvId=test123&SignatureValue=test"
```

Если получаете ответ (даже с ошибкой), значит сервер доступен. Если нет ответа или таймаут - проверьте настройки сети.

## Дополнительная информация:

- Логи бота показывают все попытки обработки платежей
- Robokassa повторяет отправку уведомлений, если не получает ответ `OK{InvId}`
- Проверьте логи вашего веб-сервера (nginx/apache), если используете прокси

